<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Image Dominant Color Analyzer (Opacity-Weighted)</title>
</head>
<body>
  <h1>Image Dominant Color Analyzer</h1>
  <p>Paste a list of image URLs (one per line):</p>
  <textarea id="urlInput" rows="10" cols="80"></textarea><br><br>
  <button id="analyzeBtn">Analyze Images</button>
  <p id="status"></p>
  <p>Results:</p>
  <textarea id="jsonOutput" rows="15" cols="80"></textarea>

  <script>
  const CORS_PROXY = "https://cors-anywhere.herokuapp.com/";
  const REFERENCE_COLORS = [
    "#4285f4", // blue
    "#34a853", // green
    "#ea4435", // red
    "#fbbc04", // yellow
    "#5f6469", // gray
    "#000000"  // black
  ];

  function hexToRgb(hex) {
    const m = hex.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);
    return m ? [parseInt(m[1],16), parseInt(m[2],16), parseInt(m[3],16)] : [0,0,0];
  }

  function colorDistance(c1, c2) {
    return Math.sqrt(
      Math.pow(c1[0]-c2[0],2) +
      Math.pow(c1[1]-c2[1],2) +
      Math.pow(c1[2]-c2[2],2)
    );
  }

  function normalizeColor(r, g, b) {
    const round = x => Math.round(x / 5) * 5;
    return [round(r), round(g), round(b)];
  }

  async function analyzeImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = () => {
        const scale = 50;
        const w = Math.min(img.width, scale);
        const h = Math.min(img.height, scale);

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        const data = ctx.getImageData(0, 0, w, h).data;
        const scores = {};
        for (const hex of REFERENCE_COLORS) scores[hex] = 0;

        let hasAlpha = false;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i+1];
          const b = data[i+2];
          const a = data[i+3];

          if (a < 255) hasAlpha = true;
          if (a === 0) continue; // ignore fully transparent pixels

          const weight = a / 255; // opacity-weighted vote
          const pixel = normalizeColor(r, g, b);

          // Find closest reference color for this pixel
          let minDist = Infinity;
          let closestHex = null;
          for (const hex of REFERENCE_COLORS) {
            const refRgb = hexToRgb(hex);
            const dist = colorDistance(pixel, refRgb);
            if (dist < minDist) {
              minDist = dist;
              closestHex = hex;
            }
          }
          scores[closestHex] += weight;
        }

        // Pick reference color with highest weighted score
        let dominant_color = REFERENCE_COLORS[0];
        let maxScore = -1;
        for (const hex of REFERENCE_COLORS) {
          if (scores[hex] > maxScore) {
            maxScore = scores[hex];
            dominant_color = hex;
          }
        }

        resolve({
          url,
          width: img.width,
          height: img.height,
          has_alpha: hasAlpha,
          dominant_color
        });
      };
      img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
      img.src = CORS_PROXY + url;
    });
  }

  async function analyzeImages(urls) {
    const results = [];
    const status = document.getElementById("status");
    for (let i = 0; i < urls.length; i++) {
      const url = urls[i].trim();
      if (!url) continue;
      status.textContent = `Processing ${i+1} of ${urls.length}: ${url}`;
      try {
        const result = await analyzeImage(url);
        results.push(result);
      } catch (err) {
        console.error("Error processing:", url, err);
      }
    }
    status.textContent = `Processing complete. ${results.length} images analyzed.`;
    return results;
  }

  document.getElementById("analyzeBtn").addEventListener("click", async () => {
    const textarea = document.getElementById("urlInput");
    const urls = textarea.value.split("\n");
    const results = await analyzeImages(urls);
    const output = document.getElementById("jsonOutput");
    output.value = JSON.stringify(results, null, 2);
    try {
      await navigator.clipboard.writeText(JSON.stringify(results, null, 2));
      alert("JSON copied to clipboard!");
    } catch (err) {
      console.error("Failed to copy JSON to clipboard:", err);
    }
  });
  </script>
</body>
</html>
