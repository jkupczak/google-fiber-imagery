<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Image Color Analyzer</title>
</head>
<body>
  <h1>Image Color Analyzer</h1>
  <p>Paste a list of image URLs (one per line):</p>
  <textarea id="urlInput" rows="10" cols="80"></textarea><br><br>
  <button id="analyzeBtn">Analyze Images</button>
  <p id="status"></p>

  <script>
  const CORS_PROXY = "https://cors-anywhere.herokuapp.com/";

  async function analyzeImage(url) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = () => {
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, img.width, img.height).data;
        const colors = new Set();
        let hasAlpha = false;

        for (let i = 0; i < imageData.length; i += 4) {
          const r = imageData[i];
          const g = imageData[i + 1];
          const b = imageData[i + 2];
          const a = imageData[i + 3];
          if (a < 255) hasAlpha = true;
          const key = `${r},${g},${b}`;
          colors.add(key);
          if (colors.size > 10) break;
        }

        let bucket;
        if (colors.size === 1) bucket = "1";
        else if (colors.size === 2) bucket = "2";
        else if (colors.size <= 10) bucket = "3-10";
        else bucket = "10+";

        resolve({
          url,
          width: img.width,
          height: img.height,
          color_count_bucket: bucket,
          has_alpha: hasAlpha
        });
      };
      img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
      img.src = CORS_PROXY + url;
    });
  }

  async function analyzeImages(urls) {
    const results = [];
    const status = document.getElementById("status");
    for (let i = 0; i < urls.length; i++) {
      const url = urls[i].trim();
      if (!url) continue;
      status.textContent = `Processing ${i + 1} of ${urls.length}: ${url}`;
      try {
        const result = await analyzeImage(url);
        results.push(result);
      } catch (err) {
        console.error("Error processing:", url, err);
      }
    }
    status.textContent = `Processing complete. ${results.length} images analyzed.`;
    return results;
  }

  function downloadJSON(data, filename = "results.json") {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function copyToClipboard(data) {
    try {
      await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
      alert("JSON copied to clipboard!");
    } catch (err) {
      console.error("Failed to copy JSON to clipboard:", err);
    }
  }

  document.getElementById("analyzeBtn").addEventListener("click", async () => {
    const textarea = document.getElementById("urlInput");
    const urls = textarea.value.split("\n");
    const results = await analyzeImages(urls);
    downloadJSON(results);
    copyToClipboard(results);
  });
  </script>
</body>
</html>
